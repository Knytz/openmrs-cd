"use strict";

const fs = require("fs");
const path = require("path");
const _ = require("lodash");

const utils = require("../utils/utils");
const model = require("../utils/model");
const cst = require("../const");
const config = require(cst.CONFIGPATH);
const db = require(cst.DBPATH);

//
//  Building the script
//
var script = new model.Script();
script.type = "#!/bin/bash";
script.headComment =
  "# Autogenerated helper script to fetch and return a given instance definition as JSON string...";

//
//  Fetching the instance definition based on the provided UUID
//
var instanceDef = db.getInstanceDefinition(
  process.env[config.varInstanceUuid()]
);
if (_.isEmpty(instanceDef)) {
  throw new Error("Illegal argument: empty or unexisting instance definition.");
}

script.body = "echo '" + JSON.stringify(instanceDef) + "'\n";

//
//  Saving the script in the current build dir.
//
fs.writeFileSync(
  path.resolve(
    config.getBuildDirPath(),
    config.getFetchInstanceDefScriptName()
  ),
  utils.getScriptAsString(script)
);
fs.chmodSync(
  path.resolve(
    config.getBuildDirPath(),
    config.getFetchInstanceDefScriptName()
  ),
  "0755"
);
